const l2 = Math.log(2);
const divlim = 4;

self.onmessage = function (e) {
  let t0 = Date.now();
  let xres = Math.floor(e.data.xres);
  let yres = Math.floor(e.data.yres);
  let dxy = e.data.xwidth / xres;
  let yheight = dxy * yres;
  let x = e.data.cx - 0.5 * e.data.xwidth;
  let xmin = e.data.cx - 0.5 * e.data.xwidth;
  let y = e.data.cy + 0.5 * yheight;
  let buffer = new Uint8ClampedArray(xres * yres * 4);
  let iterfunc = mandelbrot;
  let jzx = e.data.jzx;
  let jzy = e.data.jzy;
  let maxiter = e.data.maxiter;

  if (e.data.julia) {
    if (e.data.whichfractal == "burningship") {
      iterfunc = burningship_julia;
    } else if (e.data.whichfractal == "mandelbrot") {
      iterfunc = mandelbrot_julia;
    }
  } else {
    if (e.data.whichfractal == "burningship") {
      iterfunc = burningship;
    } else if (e.data.whichfractal == "mandelbrot") {
      iterfunc = mandelbrot;
    }
  }
  let i, j, pos, tmp;
  for (j = 0; j < yres; j++) {
    x = xmin;
    for (i = 0; i < xres; i++) {
      pos = (j * xres + i) * 4;
      tmp = iterfunc(x, -y, jzx, -jzy, maxiter, divlim);
      if (tmp === 0) {
        buffer[pos] = 0;
        buffer[pos + 1] = 0;
        buffer[pos + 2] = 0;
        buffer[pos + 3] = 255;
      } else {
        tmp = Math.floor(255 * (((6 * tmp) / maxiter + 0.1) % 1));
        buffer[pos] = red[tmp];
        buffer[pos + 1] = green[tmp];
        buffer[pos + 2] = blue[tmp];
        buffer[pos + 3] = 255;
      }
      x += dxy;
    }
    y -= dxy;
  }
  self.postMessage({
    time: Date.now() - t0,
    buffer: buffer,
    xres: xres,
    yres: yres,
  });
};

function mandelbrot_julia(zx, zy, jzx, jzy, maxiter, divlim) {
  let ztmp = 0.0;
  let iter = -1;
  while (ztmp < divlim * divlim && iter < maxiter) {
    iter += 1;
    ztmp = zx * zx - zy * zy;
    zy = 2 * zx * zy + jzy;
    zx = ztmp + jzx;
    ztmp = zx * zx + zy * zy;
  }
  if (iter === maxiter) {
    return 0;
  }
  return iter - Math.log(Math.log(Math.sqrt(ztmp)) / l2) / l2;
}

function mandelbrot(zx, zy, jzx, jzy, maxiter, divlim) {
  return mandelbrot_julia(0.0, 0.0, zx, zy, maxiter, divlim);
}

function burningship_julia(zx, zy, jzx, jzy, maxiter, divlim) {
  let ztmp = 0.0;
  let iter = -1;
  while (ztmp < divlim * divlim && iter < maxiter) {
    iter += 1;
    ztmp = zx * zx - zy * zy;
    zy = Math.abs(2 * zx * zy) + jzy;
    zx = ztmp + jzx;
    ztmp = zx * zx + zy * zy;
  }
  if (iter === maxiter) {
    return 0;
  }
  return iter - Math.log(Math.log(Math.sqrt(ztmp)) / l2) / l2;
}

function burningship(zx, zy, cx, cy, maxiter, divlim) {
  return burningship_julia(0.0, 0.0, zx, zy, maxiter, divlim);
}

const red = [
  66.0, 61.896517, 58.082669, 54.542821, 51.261339, 48.22259, 45.41094,
  42.810755, 40.406401, 38.182243, 36.122649, 34.211983, 32.434613, 30.774904,
  29.217222, 27.745933, 26.345404, 25.0, 23.696853, 22.434157, 21.212871,
  20.033954, 18.898364, 17.807062, 16.761006, 15.761156, 14.80847, 13.903907,
  13.048428, 12.24299, 11.488553, 10.786077, 10.13652, 9.540841, 9.0, 8.513912,
  8.078321, 7.687927, 7.337428, 7.021527, 6.734921, 6.472312, 6.228399,
  5.997882, 5.775461, 5.555837, 5.333708, 5.103775, 4.860738, 4.599296, 4.31415,
  4.0, 3.653767, 3.281258, 2.890501, 2.489526, 2.086362, 1.689036, 1.305577,
  0.944015, 0.612377, 0.318692, 0.07099, -0.122702, -0.254355, -0.31594,
  -0.299428, -0.196791, 0.0, 0.296219, 0.686125, 1.161222, 1.713015, 2.333006,
  3.012702, 3.743605, 4.51722, 5.325052, 6.158604, 7.009381, 7.868887, 8.728626,
  9.580103, 10.414821, 11.224285, 12.0, 12.735954, 13.436077, 14.106783,
  14.754487, 15.385603, 16.006545, 16.623729, 17.243568, 17.872477, 18.516871,
  19.183163, 19.877768, 20.607102, 21.377577, 22.195609, 23.067612, 24.0,
  24.999533, 26.074351, 27.232936, 28.483775, 29.83535, 31.296146, 32.874648,
  34.57934, 36.418705, 38.401229, 40.535395, 42.829687, 45.292591, 47.93259,
  50.758168, 53.77781, 57.0, 60.429764, 64.058298, 67.873339, 71.862623,
  76.013889, 80.314874, 84.753314, 89.316948, 93.993512, 98.770745, 103.636382,
  108.578161, 113.583821, 118.641097, 123.737727, 128.861449, 134.0, 139.140966,
  144.27133, 149.377923, 154.447577, 159.467123, 164.423394, 169.30322,
  174.093434, 178.780866, 183.352349, 187.794714, 192.094793, 196.239418,
  200.215419, 204.009628, 207.608878, 211.0, 214.173276, 217.132793, 219.886088,
  222.4407, 224.804165, 226.984021, 228.987806, 230.823057, 232.497312,
  234.018108, 235.392984, 236.629476, 237.735122, 238.71746, 239.584027,
  240.342362, 241.0, 241.565279, 242.049728, 242.465675, 242.825449, 243.141377,
  243.425787, 243.691008, 243.949369, 244.213196, 244.494818, 244.806564,
  245.160761, 245.569737, 246.045821, 246.601341, 247.248624, 248.0, 248.860948,
  249.809554, 250.817058, 251.854698, 252.893712, 253.90534, 254.860821,
  255.731392, 256.488293, 257.102761, 257.546037, 257.789358, 257.803964,
  257.561092, 257.031981, 256.187871, 255.0, 253.449714, 251.55879, 249.359113,
  246.882568, 244.161039, 241.226411, 238.110569, 234.845397, 231.462781,
  227.994604, 224.472752, 220.929109, 217.395561, 213.903991, 210.486284,
  207.174326, 204.0, 200.98522, 198.112013, 195.352434, 192.678536, 190.062377,
  187.47601, 184.89149, 182.280873, 179.616213, 176.869565, 174.012985,
  171.018528, 167.858247, 164.5042, 160.928439, 157.103021, 153.0, 148.602077,
  143.934537, 139.03331, 133.934327, 128.673517, 123.286811, 117.81014,
  112.279433, 106.730622, 101.199636, 95.722406, 90.334863, 85.072936,
  79.972555, 75.069652, 70.400157, 66.0,
];

const green = [
  30.0, 27.504717, 25.20734, 23.096846, 21.162212, 19.392416, 17.776435,
  16.303247, 14.961829, 13.741159, 12.630214, 11.617971, 10.693408, 9.845502,
  9.063231, 8.335572, 7.651502, 7.0, 6.372235, 5.768149, 5.189877, 4.639553,
  4.119313, 3.631292, 3.177623, 2.760442, 2.381883, 2.044082, 1.749173,
  1.499291, 1.296571, 1.143147, 1.041153, 0.992726, 1.0, 1.063539, 1.177627,
  1.334977, 1.528303, 1.750319, 1.993738, 2.251273, 2.515638, 2.779546,
  3.035712, 3.276848, 3.495668, 3.684885, 3.837214, 3.945367, 4.002058, 4.0,
  3.935792, 3.821569, 3.67335, 3.507157, 3.339008, 3.184925, 3.060926, 2.983032,
  2.967263, 3.029639, 3.186179, 3.452904, 3.845834, 4.380988, 5.074388,
  5.942052, 7.0, 8.259038, 9.70911, 11.334944, 13.12127, 15.052817, 17.114314,
  19.290491, 21.566075, 23.925797, 26.354385, 28.836568, 31.357076, 33.900637,
  36.451981, 38.995837, 41.516934, 44.0, 46.433104, 48.81767, 51.15846,
  53.460236, 55.727761, 57.965797, 60.179106, 62.372452, 64.550597, 66.718303,
  68.880332, 71.041447, 73.206411, 75.379986, 77.566934, 79.772018, 82.0,
  84.255034, 86.538834, 88.852508, 91.19716, 93.573898, 95.983826, 98.428052,
  100.907682, 103.423821, 105.977575, 108.570051, 111.202354, 113.875592,
  116.590869, 119.349292, 122.151967, 125.0, 127.89441, 130.835868, 133.824956,
  136.862258, 139.948356, 143.083836, 146.269278, 149.505267, 152.792386,
  156.131218, 159.522347, 162.966355, 166.463826, 170.015342, 173.621488,
  177.282846, 181.0, 184.770013, 188.575868, 192.397029, 196.212959, 200.003122,
  203.746983, 207.424003, 211.013647, 214.495378, 217.84866, 221.052957,
  224.087732, 226.932448, 229.566569, 231.96956, 234.120882, 236.0, 237.591792,
  238.902795, 239.94496, 240.730238, 241.270581, 241.577939, 241.664265,
  241.541509, 241.221623, 240.716558, 240.038265, 239.198696, 238.209802,
  237.083534, 235.831843, 234.466682, 233.0, 231.443116, 229.804811, 228.093232,
  226.316527, 224.482843, 222.600329, 220.67713, 218.721396, 216.741273,
  214.744909, 212.740451, 210.736048, 208.739845, 206.759992, 204.804635,
  202.881922, 201.0, 199.164342, 197.369719, 195.608227, 193.871963, 192.153023,
  190.443502, 188.735497, 187.021105, 185.292421, 183.541542, 181.760564,
  179.941583, 178.076695, 176.157997, 174.177584, 172.127553, 170.0, 167.789807,
  165.503002, 163.148396, 160.734802, 158.271034, 155.765903, 153.228223,
  150.666807, 148.090466, 145.508014, 142.928263, 140.360026, 137.812117,
  135.293346, 132.812528, 130.378475, 128.0, 125.682331, 123.41636, 121.189396,
  118.988746, 116.801718, 114.61562, 112.41776, 110.195446, 107.935986,
  105.626688, 103.254859, 100.807809, 98.272844, 95.637273, 92.888403,
  90.013543, 87.0, 83.84073, 80.55128, 77.152844, 73.666616, 70.113791,
  66.515562, 62.893125, 59.267673, 55.6604, 52.092502, 48.585171, 45.159603,
  41.836992, 38.638532, 35.585417, 32.698841, 30.0,
];

const blue = [
  15.0, 15.833654, 16.602982, 17.316183, 17.981458, 18.607008, 19.201033,
  19.771734, 20.32731, 20.875963, 21.425894, 21.985301, 22.562387, 23.165351,
  23.802393, 24.481716, 25.211518, 26.0, 26.853464, 27.770618, 28.748268,
  29.783223, 30.87229, 32.012278, 33.199995, 34.432249, 35.705847, 37.017598,
  38.36431, 39.74279, 41.149847, 42.582288, 44.036922, 45.510557, 47.0,
  48.502335, 50.015748, 51.5387, 53.069653, 54.607068, 56.149405, 57.695128,
  59.242696, 60.790572, 62.337216, 63.88109, 65.420656, 66.954374, 68.480706,
  69.998114, 71.505058, 73.0, 74.482402, 75.955724, 77.42443, 78.892979,
  80.365835, 81.847458, 83.34231, 84.854853, 86.389549, 87.950859, 89.543244,
  91.171167, 92.839089, 94.551472, 96.312777, 98.127466, 100.0, 101.933416,
  103.925043, 105.970787, 108.066552, 110.208242, 112.391763, 114.613018,
  116.867913, 119.152352, 121.46224, 123.79348, 126.141979, 128.50364,
  130.874368, 133.250068, 135.626643, 138.0, 140.366676, 142.725745, 145.076914,
  147.41989, 149.754383, 152.080097, 154.396743, 156.704025, 159.001653,
  161.289334, 163.566775, 165.833683, 168.089766, 170.334732, 172.568288,
  174.790142, 177.0, 179.196869, 181.376945, 183.535726, 185.668705, 187.771378,
  189.839242, 191.867791, 193.852521, 195.788928, 197.672507, 199.498753,
  201.263163, 202.961231, 204.588453, 206.140325, 207.612342, 209.0, 210.301579,
  211.526498, 212.686962, 213.795175, 214.863341, 215.903664, 216.928349,
  217.949599, 218.979619, 220.030613, 221.114786, 222.244341, 223.431482,
  224.688415, 226.027343, 227.46047, 229.0, 230.650958, 232.389645, 234.185182,
  236.006691, 237.823294, 239.604112, 241.318265, 242.934876, 244.423067,
  245.751957, 246.890669, 247.808325, 248.474045, 248.856951, 248.926165,
  248.650807, 248.0, 246.951297, 245.515982, 243.713771, 241.564381, 239.087529,
  236.302931, 233.230303, 229.889361, 226.299823, 222.481404, 218.453821,
  214.236791, 209.850029, 205.313253, 200.646178, 195.868522, 191.0, 186.056576,
  181.039203, 175.945079, 170.771403, 165.515374, 160.174192, 154.745055,
  149.225164, 143.611716, 137.901911, 132.092948, 126.182026, 120.166344,
  114.043101, 107.809497, 101.46273, 95.0, 88.425695, 81.772963, 75.082141,
  68.393566, 61.747576, 55.184507, 48.744696, 42.468482, 36.396201, 30.568189,
  25.024786, 19.806326, 14.953149, 10.50559, 6.503988, 2.988679, -0.0,
  -2.435726, -4.348234, -5.781276, -6.7786, -7.383959, -7.641101, -7.593778,
  -7.285739, -6.760735, -6.062517, -5.234834, -4.321437, -3.366076, -2.412501,
  -1.504464, -0.685713, -0.0, 0.519325, 0.880507, 1.102192, 1.203025, 1.201653,
  1.116719, 0.96687, 0.77075, 0.547006, 0.314282, 0.091224, -0.103523,
  -0.251313, -0.333501, -0.331442, -0.22649, -0.0, 0.36148, 0.850632, 1.454942,
  2.161899, 2.958989, 3.833701, 4.773521, 5.765939, 6.798441, 7.858514,
  8.933647, 10.011327, 11.079042, 12.124279, 13.134526, 14.09727, 15.0,
];
